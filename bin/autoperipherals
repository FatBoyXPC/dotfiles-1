#!/bin/bash

function main() {
    # TODO - look into running whenever power is added/removed
    # "on" or "off": POWER_STATUS=$(acpi -a | cut -d' ' -f3 | cut -d- -f1)

    HDMI_STATUS=$(</sys/class/drm/card0/*HDMI*/status)

    # TODO - look into automating this via udev, see https://wiki.archlinux.org/index.php/PulseAudio/Examples#Automatically_switch_audio_to_HDMI

    if [ $HDMI_STATUS == "connected" ]; then
        LAYOUT_NAME=mission-desk
        TRAYER_HEIGHT=19
        TERM_FONT_SIZE=8
    else
        LAYOUT_NAME=mobile
        # Temporarily trying out a a really tiny tray on mobile... TRAYER_HEIGHT=25
        TRAYER_HEIGHT=19
        TERM_FONT_SIZE=12
    fi

    size_tray $TRAYER_HEIGHT
    size_termite $TERM_FONT_SIZE
    size_chromium $LAYOUT_NAME

    # notify-send blocks until something receives the message. When booting,
    # we haven't started dunst yet, so we need to run notify-send in the background.
    notify-send "Detected environment $LAYOUT_NAME" &

    $LAYOUT_NAME.sh

    fixmouse

    # TODO - look into running this whenever a new keyboard appears
    # Note, we intentionally run fixkeys last, because xmodmap blocks if you're holding any keys down.
    # See: https://forums.fedoraforum.org/showthread.php?296298-xmodmap-please-release-the-following-keys-within-2-seconds
    fixkeys
}

function size_tray() {
    height=$1
    killall -q trayer
    trayer --edge top --align right --SetDockType true --SetPartialStrut true --expand true --width 10 --height $height --transparent true --alpha 0 --tint 0 &

    # TODO - if we want to resize xmobar, we need to:
    #         1. edit our xmobarrc
    #         2. run `xmonad --restart`
}

function size_termite() {
    font_size=$1
    ~/.config/termite/config.template.sh solarized-dark $font_size
    # <<< TODO reload all existing termite sessions >>>
}

function size_chromium() {
    LAYOUT_NAME=$1
    # 1. Set "Page zoom" in chrome://settings/?search=page+zoom to 75%.
    # 2. Reduce the size of all the chrome?? is this even possible? =(
    #    Two ways to do it that involve restarting chrome:
    #      - Change Xresources and restart chrome, but this will affect other apps as well.
    #      - chromium --force-device-scale-factor=1
    sudo ln -sf ~/bin/layouts/chromium-$LAYOUT_NAME /usr/local/sbin/chromium
}

main
